{% extends 'base.html' %}
{% load user_tags %}
{% load django_bootstrap_breadcrumbs %}
{% block breadcrumbs %}
    {{ block.super }}
    {% breadcrumb "Elektron jurnal" "user:electronical_journal" %}
{% endblock %}

{% block content %}

    <div class="row">
        <!-- left column -->
        <div class="col-md-12">
            <!-- general form elements -->
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Elektron jurnal</h3>
                </div>

                <div class="card-body">
                    <form action="{% url 'user:electronical_journal' %}" method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-3">
                                <label for="">Guruh: </label>
                                <select name="group" id="group" class="form-control"
                                        style="cursor: pointer;">
                                    {% for group in groups %}
                                        <option {% if render_group.id == group.id %}selected{% endif %}
                                                value="{{ group.id }}">{{ group.category }}-{{ group.number }}-{{ group.year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="">Fan: </label>
                                <select name="subject" id="subject" class="form-control"
                                        style="cursor: pointer;">
                                    {% for subject in subjects %}
                                        <option {% if render_subject.id == subject.id %}selected{% endif %}
                                                value="{{ subject.id }}">{{ subject.long_title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="">O'quv oyi: </label>
                                <select name="month" id="month" class="form-control"
                                        style="cursor: pointer;">
                                    {% for months_and_year in months_and_years %}
                                        <option {% if selected_months_and_years == months_and_year %}selected{% endif %}
                                                value="{{ months_and_year }}">{{ months_and_year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2" style="margin-top: 1.9rem; text-align: center">
                                <button class="btn btn-info">Yangilash</button>
                            </div>
                        </div>
                    </form>
                    <br>
                    <div class="table-responsive">
                        <table style="font-size: 0.9rem" id="example1"
                               class="table table-bordered table-hovered table-hover">
                            <thead>
                            <tr style="background-color: #faf7f7">
                                {% if render_group and render_subject %}
                                    {% get_fullname_group render_group.id as group_name %}
                                    <th style="text-align: center; font-size: xx-large; color: #5353d5"
                                        colspan="{{ cols|length|add:2 }}">
                                        Guruh: {{ group_name }} &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
                                        Fan: {{ render_subject.long_title }}
                                    </th>
                                {% else %}
                                    {% get_fullname_group groups.first.id as group_name %}

                                    <th style="text-align: center; font-size: xx-large; color: #737399"
                                        colspan="{{ cols|length|add:2 }}">
                                        Guruh: {{ group_name }} &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
                                        Fan: {{ subjects.first.long_title }}
                                    </th>
                                {% endif %}
                            </tr>
                            </thead>
                            <tbody>

                            <tr>
                                <td rowspan="2"
                                    style="font-weight: bolder; text-align: center; vertical-align: revert; width: 6px;padding: 0; margin: 0">
                                    â„–
                                </td>
                                <td rowspan="2"
                                    style="font-weight: bolder; text-align: center; vertical-align: revert; width: 25em;padding: 0; margin: 0">
                                    F.I.SH
                                </td>

                                <td colspan="{{ cols|length }}"
                                    style="width: 6px; font-weight: bolder; text-align: center; font-size: 1.5em; padding: 0; margin: 0">
                                    Davomat va joriy baholar
                                </td>
                            </tr>

                            <tr>
                                {% for col in cols %}
                                    <td style="width: 6px; font-weight: bolder;margin-left: 0">
                                        <div class="vertical">{{ col }}</div>
                                    </td>
                                {% endfor %}

                            </tr>
                            {% if rows %}
                                {% for row in rows %}
                                    <tr>
                                    <th>{{ forloop.counter }}</th>
                                    <th>{{ row.name }}</th>

                                    {% for col in cols %}
                                        {% if subject %}
                                            {% get_pupil_rating_or_attendance row.id col subject.id as rating_or_attendance %}
                                        {% else %}
                                            {% get_pupil_rating_or_attendance row.id col subjects.first.id as rating_or_attendance %}
                                        {% endif %}
                                        <th>
                                            {% if rating_or_attendance.attendance == False %}
                                                <span style="color: red">dk</span>
                                            {% elif rating_or_attendance.attendance == True %}
                                                <span>{{ rating_or_attendance.rating }}</span>
                                            {% endif %}
                                        </th>

                                    {% endfor %}
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <th style="color: red; text-align: center" colspan="{{ cols|length|add:2 }}">
                                        O'quvchilar mavjud emas!
                                    </th>
                                </tr>
                            {% endif %}
                            <tr>
                                <td colspan="{{ cols|length|add:2 }}"><span
                                        style="color: red; float: right">dk - darsga kelmagan</span></td>
                            </tr>
                            </tbody>
                            <tfoot>

                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


{% endblock content %}
{% block bottom %}

    <script type="text/javascript">

        var csrftoken = getCookie('csrftoken');

        $.ajaxSetup({
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-CSRFToken', csrftoken)
            }
        })

        $("#group").change(function () {
            var selectedGroup = $(this).children("option:selected").val();
            $.ajax({
                type: "POST",
                url: "{% url 'user:get_group_months' %}",
                data: {
                    'group': selectedGroup, // from form
                },
                success: function (message) {
                    if (message) {
                        $('#month').empty().append(message)

                        $('#month').css('border-color', '#007bff')
                        setTimeout(function () {
                            $('#month').css('border-color', '#ced4da')
                        }, 2000)
                    }
                }
            });
        });
    </script>

{% endblock bottom %}
